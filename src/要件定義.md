# 0. 目的・スコープ

* **目的**: Webカメラ映像から手指ランドマークを推定し、**指定した2点（既定: 親指先=4 と人差し指先=8）間の距離**をリアルタイム表示する。
* **スコープ**: 単一アプリ（Electron）。カメラ入力、推定、距離算出、画面表示、最小限の平滑化・設定UI。
* **非スコープ**: OS操作入力の注入、MIDI/OSC送出、複数カメラ切替の高度制御、学習/再学習、クラウド連携。

# 1. 用語

* **正規化座標**: 画像サイズに対して 0–1 の範囲で表現された座標。
* **ピクセル距離**: 画像解像度に依存するpx単位の距離。
* **ワールド座標**: モデルが推定する3D（m近似）。PoCでは表示オプション扱い。

# 2. ユースケース（PoC）

1. ユーザーがアプリを起動 → カメラ許可 → プレビュー表示。
2. 片手を映すとランドマークが重畳表示され、**4–8 の距離**が数値で更新される。
3. 右側パネルで「正規化/px/（任意）ワールド」の表示切替と、しきい値・平滑化の設定ができる。
4. 検出ロスト時は「No Hand」表示。

# 3. 機能要件（FR）

## FR-1 カメラ入力

* **FR-1.1** `getUserMedia` により単一Webカメラを取得（解像度デフォルト 640×480、設定で720p可）。
* **FR-1.2** 起動時にカメラアクセス権を要求。拒否時は再試行ボタンとガイダンスを表示。

## FR-2 手指ランドマーク推定（MediaPipe Tasks）

* **FR-2.1** `@mediapipe/tasks-vision` の HandLandmarker を使用。`numHands=1` を既定。
* **FR-2.2** 推論モードは VIDEO/STREAM（1フレームごとに `detectForVideo`）。
* **FR-2.3** フレームごとにランドマーク（正規化座標）を取得。可能なら worldLandmarks も取得。

## FR-3 距離算出・平滑化

* **FR-3.1** 既定はランドマークID **4（親指先）** と **8（人差し指先）** のユークリッド距離。
* **FR-3.2** 距離は以下を計算・保持

  * 正規化距離（解像度非依存）
  * ピクセル距離（video.width/heightから換算）
  * （オプション）ワールド距離（取得可能な環境のみ）
* **FR-3.3** ノイズ低減: \*\*EMA（指数移動平均）\*\*を適用（αは設定可能、既定0.5）。
* **FR-3.4** 検出欠落フレームでは前回値を保持せず、**N/A** として連続グラフは欠測処理。

## FR-4 UI表示

* **FR-4.1** メイン: 映像プレビュー上に骨格ライン・各関節点（小円）を重畳表示。
* **FR-4.2** サイドパネルに現在値（正規化・px・（任意）m）を数値とバーで表示。
* **FR-4.3** 簡易時系列グラフ（直近5–10秒）を折れ線で表示。
* **FR-4.4** ステータス表示: `DETECTING / NO HAND / LOW CONFIDENCE`。
* **FR-4.5** 設定UI（右パネル）

  * 対象ランドマークペア（既定: 4–8）
  * 平滑化α（0–1）
  * フレーム目標FPS（30/60の目標値）
  * 表示単位切替（正規化/px/（任意）m）
  * ランドマーク重畳のON/OFF

## FR-5 設定の永続化

* **FR-5.1** ユーザー設定はローカル保存（`electron-store` 等）し、次回起動時に復元。

## FR-6 例外・エラー処理

* **FR-6.1** カメラ取得失敗時: メッセージ＋再試行、権限設定の案内（OS別ヘルプリンクはローカル文言）。
* **FR-6.2** モデル/アセット読込失敗時: リトライ、パス検証、デバッグログ出力。
* **FR-6.3** FPSが著しく低下した場合、**自動で解像度を段階的に下げる**（720p→480p）。

# 4. 非機能要件（NFR）

* **NFR-1 パフォーマンス**

  * 既定（640×480, numHands=1）で **実測 20–30 FPS** を目標。
  * **エンドツーエンド遅延 < 120ms（中央値）**。
* **NFR-2 安定性**

  * 10分以上の連続稼働でクラッシュ/メモリリークがないこと。
* **NFR-3 オフライン**

  * 初回インストール済みで**ネット接続不要**（WASM・.taskは同梱）。
* **NFR-4 移植性**

  * 最低限 macOS / Windows のいずれかで安定動作。優先OSは本プロジェクトで決める。
* **NFR-5 使用感**

  * 起動→計測可能状態まで **5秒以内**（初回モデルロードを含む）。

# 5. アーキテクチャ/構成

* **Electron（Renderer）**:

  * カメラ取得、HandLandmarker実行（WASM）、描画（Canvas/WebGL）。
  * 設定UI、オーバーレイ描画、距離・グラフ表示。
* **Electron（Main）**:

  * ウィンドウ管理、設定永続化（`electron-store`）、ログ。
  * 将来のOS連携（仮想マウス/MIDI等）に備えたIPC終端。
* **アセット配置**:

  * `public/assets/hand_landmarker.task`
  * `public/wasm/`（`FilesetResolver.forVisionTasks(wasmRoot, assetsRoot)` の2引数で解決）
* **依存ライブラリ案**

  * `@mediapipe/tasks-vision`（手指推定）
  * `zod`（設定バリデーション）
  * `electron-store`（設定保存）
  * `vite` + `electron-builder/forge`（ビルド）

# 6. 処理フロー（概略）

1. 起動 → 設定ロード → ウィンドウ生成
2. WASM/Taskモデル読込 → カメラ許可 → ストリーム開始
3. `requestAnimationFrame` （または `requestVideoFrameCallback`）でフレーム取得
4. `handLandmarker.detectForVideo(video, ts)` 実行
5. ランドマーク抽出 → 指定ID間距離計算 → EMA平滑化
6. UI更新（数値・バー・時系列・オーバーレイ）
7. 例外時のエラーハンドリング／自動ダウングレード

# 7. データ/設定項目

* **アプリ設定**

  * `pair: {a: number, b: number}`（既定 `{4,8}`）
  * `unit: "normalized" | "px" | "world"`（既定 `"normalized"`）
  * `alpha: number`（0–1, 既定0.5）
  * `targetFps: 30 | 60`（既定30）
  * `resolution: "480p" | "720p"`（既定480p）
  * `overlay: boolean`（既定true）
* **ランタイム状態**

  * `status: "DETECTING" | "NO_HAND" | "LOW_CONF"`
  * `distanceRaw`, `distanceEma`, `confidence`
  * `series[]`（時系列データ、最大600点=10秒@60FPS）

# 8. UI仕様（画面）

* **メインビュー**: 左にカメラ映像（16:9/4:3自動レターボックス）。ランドマーク点（小円）、骨格線（半透明）。
* **右パネル**:

  * 現在値カード（正規化値を大きく表示、px/mは小さく）
  * 時系列グラフ（最新優先、N/Aはギャップ）
  * 設定フォーム（上記項目）
  * ステータス/エラー表示
* **アクセシビリティ**: 数値は**小数第3位**まで、色覚差に配慮（形＋ラベル）。

# 9. セキュリティ/プライバシ

* 画像処理はローカルのみ。映像は保存しない（初期状態）。
* 設定と一時データのみローカル保存。
* 許可/権限は最小限（カメラのみ）。

# 10. ログ/診断

* **標準ログ**: 起動、モデルロード、権限付与/拒否、FPSサマリ（10秒ごと）。
* **デバッグモード**: ランドマーク信頼度、処理時間（ms）をオーバーレイに表示。
* ログはローカル（ローテーション、最大ファイルサイズ指定）。

# 11. テスト計画（要点）

* **機能テスト**:

  * 検出時に距離が更新されること。
  * 手を外したら `NO HAND` 表示になること。
  * 設定の変更が即時反映・永続化されること。
* **環境テスト**:

  * 明/暗所、逆光、速い動き、背景の手以外の物体。
  * ノートPC内蔵カメラ/外付けWebカメラ。
* **パフォーマンス**:

  * 480p: 30FPS 以上（中央値）
  * 720p: 20FPS 以上（中央値）
  * 連続10分でエラー無し、メモリ増加が安定範囲。
* **例外系**:

  * カメラ拒否、アセット欠落、WASMロード失敗。

# 12. 受け入れ基準（Definition of Done）

* アプリ起動から5秒以内にプレビューと距離表示が開始される。
* 480p設定で **30FPS（中央値）** を満たす。
* ランドマーク4–8間の**正規化距離が連続して視認可能**で、手を外すと **1秒以内にNO HAND** 表示。
* 設定変更（α・単位・解像度）が即時有効で、再起動後も保持。
* 10分連続稼働でクラッシュ/顕著なメモリリークなし。

# 13. リスクと対策

* **低FPS/高遅延**: 自動解像度ダウン、`numHands=1`固定、描画の簡素化（骨格線OFF）。
* **検出不安定（遮蔽/画角）**: 距離のヒステリシスは今回は不要だが、**EMA**で揺れを抑制。必要に応じてON/OFF。
* **環境差（照明/カメラ画質）**: 露出固定/オート設定のガイダンスをヘルプに記載。
* **配布時のアセットパス不整合**: Viteの`public`直下固定、起動時に自己診断。

# 14. ロードマップ（PoC→拡張）

* **スプリント1（PoC完成）**: カメラ取得、Landmarker、距離算出/表示、EMA、設定保存。
* **スプリント2（安定化）**: 自動解像度調整、ログ、デバッグオーバーレイ、簡易グラフ。
* **スプリント3（拡張候補）**:

  * ランドマークペアの複数プリセット（ピンチ/中指距離 など）
  * 2手対応と「一番信頼度の高い手」を自動選択
  * ワールド距離表示（キャリブレーション）
  * スナップショット/CSVエクスポート

